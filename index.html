<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turma da Fralda - Orçamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .form-section {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #fb7185;
            box-shadow: 0 0 0 2px #fecdd3;
        }
        .btn-primary {
            background-color: #f43f5e;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: none;
        }
        .btn-primary:hover {
            background-color: #e11d48;
        }
        .btn-primary:disabled {
            background-color: #fda4af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <div class="inline-flex items-center gap-4">
                 <div class="flex">
                    <div class="w-10 h-10 bg-blue-300 flex items-center justify-center rounded-lg text-white font-bold text-2xl transform -rotate-6">T</div>
                    <div class="w-10 h-10 bg-pink-400 flex items-center justify-center rounded-lg text-white font-bold text-2xl transform rotate-6 -ml-2">F</div>
                </div>
                <h1 class="text-3xl font-bold text-slate-800">Turma da Fralda - Orçamentos</h1>
            </div>
        </header>

        <main id="mainForm">
            <!-- Seção de Dados do Cliente -->
            <section class="form-section">
                <h2 class="text-xl font-bold mb-4 text-slate-700">1. Dados do Cliente e Negócio</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="clientName" class="block mb-1 font-medium text-slate-600">Nome Completo do Cliente</label>
                        <input type="text" id="clientName" class="form-input" placeholder="Ex: Thaísa Cristina Maranhão Martins">
                    </div>
                     <div>
                        <label for="phoneNumber" class="block mb-1 font-medium text-slate-600">Telefone do Cliente (com DDI/DDD)</label>
                        <input type="tel" id="phoneNumber" class="form-input" placeholder="Ex: 5513999998888">
                    </div>
                    <div>
                        <label for="region" class="block mb-1 font-medium text-slate-600">Região de Atendimento</label>
                        <select id="region" class="form-input">
                            <option value="Baixada Santista">Baixada Santista</option>
                            <option value="São Paulo">São Paulo</option>
                        </select>
                    </div>
                    <div>
                        <label for="city" class="block mb-1 font-medium text-slate-600">Cidade do Atendimento</label>
                        <input type="text" id="city" class="form-input" placeholder="Ex: Santos">
                    </div>
                    <div>
                        <label for="neighborhood" class="block mb-1 font-medium text-slate-600">Bairro</label>
                        <input type="text" id="neighborhood" class="form-input" placeholder="Ex: Marapé">
                    </div>
                </div>
            </section>

            <!-- Seção de Serviço e Plano -->
            <section class="form-section">
                <h2 class="text-xl font-bold mb-4 text-slate-700">2. Serviço e Plano</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="serviceType" class="block mb-1 font-medium text-slate-600">Tipo de Serviço</label>
                        <select id="serviceType" class="form-input">
                            <option value="Cuidar e Brincar">Cuidar e Brincar</option>
                            <option value="Cuidar e Educar">Cuidar e Educar</option>
                            <option value="Cuidar e Acolher">Cuidar e Acolher</option>
                        </select>
                    </div>
                    <div>
                        <label for="plan" class="block mb-1 font-medium text-slate-600">Plano</label>
                        <select id="plan" class="form-input">
                            <option value="Esporádico">Esporádico</option>
                            <option value="Mensal fixo">Mensal fixo</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Seção de Configuração de Dias e Horários -->
            <section class="form-section">
                <h2 class="text-xl font-bold mb-4 text-slate-700">3. Dias e Horários</h2>
                <!-- Campos para Plano Mensal -->
                <div id="monthly-fields" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="contract-duration" class="block mb-1 font-medium text-slate-600">Duração do Contrato (meses)</label>
                            <input type="number" id="contract-duration" class="form-input" value="1" min="1">
                        </div>
                        <div>
                            <label for="start-date" class="block mb-1 font-medium text-slate-600">Mês/Ano de Início</label>
                            <input type="month" id="start-date" class="form-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                         <div>
                            <label class="block mb-1 font-medium text-slate-600">Dias da Semana</label>
                            <div id="monthly-days-checkboxes" class="flex flex-wrap gap-x-4 gap-y-2">
                                <label class="flex items-center"><input type="checkbox" value="1" class="mr-2">Seg</label>
                                <label class="flex items-center"><input type="checkbox" value="2" class="mr-2">Ter</label>
                                <label class="flex items-center"><input type="checkbox" value="3" class="mr-2">Qua</label>
                                <label class="flex items-center"><input type="checkbox" value="4" class="mr-2">Qui</label>
                                <label class="flex items-center"><input type="checkbox" value="5" class="mr-2">Sex</label>
                                <label class="flex items-center"><input type="checkbox" value="6" class="mr-2">Sáb</label>
                                <label class="flex items-center"><input type="checkbox" value="0" class="mr-2">Dom</label>
                            </div>
                        </div>
                        <div>
                            <label for="monthly-start-time" class="block mb-1 font-medium text-slate-600">Horário de Entrada</label>
                            <input type="time" id="monthly-start-time" class="form-input">
                        </div>
                        <div>
                            <label for="monthly-end-time" class="block mb-1 font-medium text-slate-600">Horário de Saída</label>
                            <input type="time" id="monthly-end-time" class="form-input">
                        </div>
                    </div>
                     <!-- Opção de Intervalo (Apenas para Mensal) -->
                    <div id="monthly-break-section" class="mt-4 border-t pt-4">
                        <label for="monthly-break-option" class="block mb-1 font-medium text-slate-600">Intervalo da Profissional</label>
                        <select id="monthly-break-option" class="form-input">
                            <option value="0">Sem intervalo</option>
                            <option value="15">15 minutos de intervalo</option>
                            <option value="60">1 hora de intervalo</option>
                        </select>
                    </div>
                </div>

                <!-- Campos para Plano Esporádico -->
                <div id="sporadic-fields">
                    <div id="sporadic-dates-container" class="space-y-4">
                    </div>
                    <button type="button" id="add-sporadic-date" class="btn-secondary mt-4">Adicionar Data</button>
                </div>
            </section>
            
            <!-- Seção de Detalhes Adicionais -->
            <section class="form-section">
                <h2 class="text-xl font-bold mb-4 text-slate-700">4. Detalhes Adicionais</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label for="professionals" class="block mb-1 font-medium text-slate-600">Nº de Profissionais</label>
                        <input type="number" id="professionals" class="form-input" value="1" min="1">
                    </div>
                     <div>
                        <label for="children" class="block mb-1 font-medium text-slate-600">Nº de Crianças</label>
                        <input type="number" id="children" class="form-input" value="1" min="1">
                    </div>
                    <div>
                        <label for="childrenAge" class="block mb-1 font-medium text-slate-600">Idade das Crianças</label>
                        <input type="text" id="childrenAge" class="form-input" placeholder="Ex: 10 meses">
                    </div>
                    <div>
                        <label for="validity" class="block mb-1 font-medium text-slate-600">Validade (dias)</label>
                        <input type="number" id="validity" class="form-input" value="10" min="1">
                    </div>
                </div>
            </section>

            <!-- Seção de Descontos e Observações -->
             <section class="form-section">
                <h2 class="text-xl font-bold mb-4 text-slate-700">5. Descontos, Adicionais e Observações</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="discount-percent" class="block mb-1 font-medium text-slate-600">Desconto (%)</label>
                        <input type="number" id="discount-percent" class="form-input" value="0" min="0">
                    </div>
                    <div>
                        <label for="discount-value" class="block mb-1 font-medium text-slate-600">Desconto (R$)</label>
                        <input type="number" id="discount-value" class="form-input" value="0" min="0">
                    </div>
                </div>
                <div class="mt-4 border-t pt-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="emergency-addon-checkbox" class="h-4 w-4 rounded border-gray-300 text-pink-600 focus:ring-pink-500">
                        <label for="emergency-addon-checkbox" class="ml-3 block font-medium text-slate-600">Adicional Emergencial (20% sobre o subtotal)</label>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="observations" class="block mb-1 font-medium text-slate-600">Observações</label>
                    <textarea id="observations" class="form-input" rows="3" placeholder="Ex: Transporte da babá gratuito..."></textarea>
                </div>
            </section>

            <!-- Botão de Ação Principal -->
            <div class="text-center mt-8">
                <button type="button" id="main-action-btn" class="btn-primary text-lg">Enviar para Automação</button>
            </div>
        </main>
    </div>

    <script>
        let priceTable = {};
        let sporadicDateCount = 0;

        async function fetchPriceTable() {
            const mainBtn = document.getElementById('main-action-btn');
            mainBtn.disabled = true;
            mainBtn.textContent = 'Carregando preços...';
            const AIRTABLE_BASE_ID = 'app5u73geOfUbS3Vm';
            const AIRTABLE_PERSONAL_ACCESS_TOKEN = 'patemUllkLwPmlk21.976396036336c69ce14d96b56e83adff35ab3b5265f4ba676e7b29b86e5d5d44';
            const AIRTABLE_TABLE_NAME = 'Tabela de Preços'; 
            const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${AIRTABLE_PERSONAL_ACCESS_TOKEN}` } });
                if (!response.ok) throw new Error(`Erro do Airtable: ${response.status}`);
                const data = await response.json();
                priceTable = formatAirtableData(data.records);
                mainBtn.disabled = false;
                mainBtn.textContent = 'Enviar para Automação';
            } catch (error) {
                console.error(error);
                alert('Não foi possível carregar a tabela de preços. Verifique as chaves e o nome da tabela no Airtable.');
            }
        }

        function formatAirtableData(records) {
            const formattedTable = {};
            records.forEach(record => {
                const { Região, "Tipo de Serviço": service, Plano, "Preço por Hora (R$)": base, "Adicional Noturno (R$)": night, "Adicional Dom/Feriado (R$)": sunday, "Adicional Criança Extra (R$)": child } = record.fields;
                if (Região && service && Plano) {
                    if (!formattedTable[Região]) formattedTable[Região] = {};
                    if (!formattedTable[Região][service]) formattedTable[Região][service] = {};
                    formattedTable[Região][service][Plano] = { base: base || 0, night: night || 0, sunday: sunday || 0, child: child || 0 };
                }
            });
            return formattedTable;
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchPriceTable();
            const planSelect = document.getElementById('plan');
            planSelect.addEventListener('change', () => {
                const isMonthly = planSelect.value === 'Mensal fixo';
                document.getElementById('monthly-fields').classList.toggle('hidden', !isMonthly);
                document.getElementById('sporadic-fields').classList.toggle('hidden', isMonthly);
            });
            document.getElementById('add-sporadic-date').addEventListener('click', addSporadicDate);
            document.getElementById('main-action-btn').addEventListener('click', submitQuote);
            addSporadicDate();
        });

        function addSporadicDate() {
            sporadicDateCount++;
            const container = document.getElementById('sporadic-dates-container');
            const newDateEntry = document.createElement('div');
            newDateEntry.className = 'grid grid-cols-1 md:grid-cols-4 gap-4 p-4 border rounded-lg';
            newDateEntry.innerHTML = `
                <div><label class="block mb-1 text-sm font-medium text-slate-500">Data ${sporadicDateCount}</label><input type="date" class="form-input sporadic-date"></div>
                <div><label class="block mb-1 text-sm font-medium text-slate-500">Entrada</label><input type="time" class="form-input sporadic-start-time"></div>
                <div><label class="block mb-1 text-sm font-medium text-slate-500">Saída</label><input type="time" class="form-input sporadic-end-time"></div>
                <div><label class="block mb-1 text-sm font-medium text-slate-500">Intervalo</label><select class="form-input sporadic-break">
                    <option value="0">Sem intervalo</option>
                    <option value="15">15 min</option>
                    <option value="60">1 hora</option>
                </select></div>
            `;
            container.appendChild(newDateEntry);
        }

        function calculateNightHours(start, end) {
            let nightHours = 0;
            let current = new Date(start);
            while (current < end) {
                let next = new Date(current);
                next.setMinutes(next.getMinutes() + 1);
                if (next > end) next = end;
                const currentHour = current.getHours();
                if (currentHour >= 22 || currentHour < 5) {
                    nightHours += (next - current) / (1000 * 60 * 60);
                }
                current = next;
            }
            return nightHours;
        }

        async function submitQuote() {
            const mainBtn = document.getElementById('main-action-btn');
            mainBtn.disabled = true;
            mainBtn.textContent = 'Enviando para automação...';

            try {
                const quoteData = {
                    phoneNumber: document.getElementById('phoneNumber').value,
                    clientName: document.getElementById('clientName').value,
                    region: document.getElementById('region').value,
                    city: document.getElementById('city').value,
                    neighborhood: document.getElementById('neighborhood').value,
                    serviceType: document.getElementById('serviceType').value,
                    plan: document.getElementById('plan').value,
                    numChildren: parseInt(document.getElementById('children').value) || 1,
                    childrenAge: document.getElementById('childrenAge').value,
                    numProfessionals: parseInt(document.getElementById('professionals').value) || 1,
                    observations: document.getElementById('observations').value,
                    validity: document.getElementById('validity').value,
                    contractDuration: document.getElementById('contract-duration').value,
                    startDate: document.getElementById('start-date').value,
                };
                
                if(!quoteData.phoneNumber) {
                    throw new Error("Por favor, insira o Telefone do Cliente.");
                }

                const prices = priceTable[quoteData.region]?.[quoteData.serviceType]?.[quoteData.plan];
                if (!prices) {
                    throw new Error('Tabela de preços não encontrada. Verifique os dados no Airtable.');
                }
                
                let totalHours = 0, totalNightHours = 0, totalSundayHours = 0;
                let conditionsText = "", serviceDatesText = "", servicePeriodText = "";

                if (quoteData.plan === 'Esporádico') {
                    const dateEntries = document.querySelectorAll('#sporadic-dates-container > div');
                    let totalMinutes = 0, serviceDays = 0;
                    const datesArray = [];
                    
                    dateEntries.forEach(entry => {
                        const dateVal = entry.querySelector('.sporadic-date').value, startVal = entry.querySelector('.sporadic-start-time').value, endVal = entry.querySelector('.sporadic-end-time').value;
                        const breakMinutes = parseInt(entry.querySelector('.sporadic-break').value, 10);
                        if (dateVal && startVal && endVal) {
                            serviceDays++;
                            const start = new Date(`${dateVal}T${startVal}`);
                            let end = new Date(`${dateVal}T${endVal}`);
                            if (end < start) end.setDate(end.getDate() + 1);
                            
                            let displayHours = (end - start) / (1000 * 60 * 60);
                            let durationHours = Math.max(0, displayHours - (breakMinutes / 60));

                            totalMinutes += durationHours * 60;
                            totalHours += durationHours;
                            totalNightHours += calculateNightHours(start, end);
                            if (start.getDay() === 0) totalSundayHours += durationHours;
                            datesArray.push({date: new Date(dateVal+'T00:00:00'), start: startVal, end: endVal, duration: displayHours, breakMinutes});
                        }
                    });
                    
                    // Lógica de agrupamento de datas
                    const datesByMonth = datesArray.reduce((acc, curr) => {
                        const monthYear = curr.date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                        if (!acc[monthYear]) acc[monthYear] = [];
                        acc[monthYear].push(curr.date.getDate());
                        return acc;
                    }, {});
                    serviceDatesText = "sendo " + Object.entries(datesByMonth).map(([monthYear, days]) => `dias ${days.sort((a, b) => a - b).join(', ')} de ${monthYear}`).join(';\n');

                    // Lógica de agrupamento de períodos
                    const periodsByTime = datesArray.reduce((acc, curr) => {
                        const breakTextMap = {0: "", 15: ", com 15min de intervalo", 60: ", com 1h de intervalo"};
                        const breakInfo = breakTextMap[curr.breakMinutes];
                        const timeKey = `das ${curr.start} às ${curr.end}${breakInfo}`;
                        if (!acc[timeKey]) acc[timeKey] = [];
                        acc[timeKey].push(curr.date.getDate());
                        return acc;
                    }, {});
                    servicePeriodText = Object.entries(periodsByTime).map(([timeKey, days]) => {
                        const dayList = days.sort((a, b) => a - b).join(', ');
                        const firstEntry = datesArray.find(d => d.date.getDate() === days[0]);
                        const durationH = Math.floor(firstEntry.duration);
                        const durationM = Math.round((firstEntry.duration % 1) * 60);
                        return `${timeKey} (${durationH}h${durationM > 0 ? durationM+'min' : ''} por dia) nos dias ${dayList}`;
                    }).join(';\n');

                    const totalCalcHours = Math.floor(totalMinutes / 60);
                    const totalCalcMins = Math.round(totalMinutes % 60);
                    conditionsText = `${totalCalcHours} hora(s) e ${totalCalcMins} minuto(s) (contados para ${serviceDays} dia(s) de atendimento).`;

                } else { // Mensal
                    const startTime = document.getElementById('monthly-start-time').value, endTime = document.getElementById('monthly-end-time').value;
                    const breakMinutes = parseInt(document.getElementById('monthly-break-option').value, 10);
                    const selectedDays = Array.from(document.querySelectorAll('#monthly-days-checkboxes input:checked'));
                    const numDaysPerWeek = selectedDays.length;
                    if (!quoteData.startDate || !startTime || !endTime || numDaysPerWeek === 0) {
                         throw new Error("Para o plano mensal, por favor, preencha a Duração, Mês/Ano de Início, Dias da Semana e Horários.");
                    }
                    const start = new Date(`1970-01-01T${startTime}`);
                    let end = new Date(`1970-01-01T${endTime}`);
                    if (end < start) end.setDate(end.getDate() + 1);
                    
                    let displayHours = (end - start) / (1000 * 60 * 60);
                    let dailyHours = Math.max(0, displayHours - (breakMinutes / 60));
                    let breakText = "";
                    if (breakMinutes === 15) breakText = ", com 15min de intervalo";
                    if (breakMinutes === 60) breakText = ", com 1h de intervalo";

                    const dailyNightHours = calculateNightHours(start, end);
                    const weeklyFactor = numDaysPerWeek <= 5 ? 4.4 : 4.2;
                    totalHours = dailyHours * numDaysPerWeek * weeklyFactor;
                    totalNightHours = dailyNightHours * numDaysPerWeek * weeklyFactor;
                    let includesWeekend = false;
                    selectedDays.forEach(day => { if (day.value === '0') {
                        totalSundayHours += dailyHours * 4.2;
                        includesWeekend = true;
                    }});
                    const dayNames = {0: 'Domingo', 1: 'Segunda', 2: 'Terça', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'Sábado'};
                    const startDate = new Date(quoteData.startDate + '-02T00:00:00');
                    const startMonth = startDate.toLocaleString('pt-BR', { month: 'long' });
                    const startYear = startDate.getFullYear();
                    conditionsText = `Contrato para ${quoteData.contractDuration} meses de atendimento, início ${startMonth}/${startYear}.`;
                    serviceDatesText = `Atendimento de ${selectedDays.map(d => dayNames[d.value]).join(', ')}. ${includesWeekend ? '' : 'Apenas dias úteis.'}`;
                    const durationH = Math.floor(displayHours);
                    const durationM = Math.round((displayHours % 1) * 60);
                    servicePeriodText = `Das ${startTime} às ${endTime} (${durationH}h${durationM > 0 ? durationM+'min' : ''} por dia${breakText}).`;
                }
                
                const discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;
                let baseCost = totalHours * prices.base;
                let nightCost = totalNightHours * prices.night;
                let sundayCost = totalSundayHours * prices.sunday;
                let childCost = (quoteData.numChildren > 1) ? totalHours * prices.child * (quoteData.numChildren - 1) : 0;
                
                baseCost *= quoteData.numProfessionals;
                nightCost *= quoteData.numProfessionals;
                sundayCost *= quoteData.numProfessionals;
                childCost *= quoteData.numProfessionals;

                const subtotal = baseCost + nightCost + sundayCost + childCost;
                const hasEmergencyAddon = document.getElementById('emergency-addon-checkbox').checked;
                let emergencyAddonValue = hasEmergencyAddon ? subtotal * 0.20 : 0;
                const discountValue = parseFloat(document.getElementById('discount-value').value) || 0;
                const valueBeforeDiscount = subtotal + emergencyAddonValue;
                let totalDiscount = (valueBeforeDiscount * (discountPercent / 100)) + discountValue;
                const totalCost = valueBeforeDiscount - totalDiscount;

                // ==================================================================
                // ATENÇÃO: SUBSTITUA PELA SUA URL REAL DO WEBHOOK DO MAKE.COM
                // ==================================================================
                const WEBHOOK_URL = 'https://hook.eu2.make.com/l8m0jixritokjk8bxo2flv1lllrtaddq';

                const finalPayload = { ...quoteData, totalCost: totalCost.toFixed(2), baseCost: baseCost.toFixed(2), nightCost: nightCost.toFixed(2), sundayCost: sundayCost.toFixed(2), childCost: childCost.toFixed(2), emergencyAddon: emergencyAddonValue.toFixed(2), totalDiscount: totalDiscount.toFixed(2), discountPercent, conditionsText, serviceDatesText, servicePeriodText };
                const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalPayload) });
                
                if (response.ok) {
                    alert('Orçamento enviado com sucesso! O PDF será gerado em instantes no seu Google Drive.');
                    mainBtn.textContent = 'Orçamento Enviado!';
                    setTimeout(() => { mainBtn.disabled = false; mainBtn.textContent = 'Enviar para Automação'; }, 3000);
                } else { 
                    throw new Error('A automação retornou um erro.'); 
                }

            } catch (error) {
                console.error(error);
                alert(`Ocorreu um erro: ${error.message}`);
                mainBtn.disabled = false;
                mainBtn.textContent = 'Tentar Novamente';
            }
        }
    </script>
</body>
</html>
